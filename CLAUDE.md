# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## プロジェクト概要
複数のAWSアカウントのコスト分析をシンプルに行える可視化ツールを開発する。
docs/requirements.mdに要件の詳細を記載している。

## 重要: ドキュメントファイル配置
**プロジェクトドキュメントは全て `docs/` ディレクトリに配置されています。**
- `docs/requirements.md` - 機能要件定義
- `docs/task-progress.md` - タスク進捗管理
- `docs/development-log.md` - 開発ログ・履歴
- `docs/ISSUES.md` - Issue管理・追跡

ドキュメント検索時は必ずdocs/ディレクトリ内を確認してください。

## 技術スタック
- **HTML5** - 基本構造とUI
- **Vanilla JavaScript** - CSV読み込み・データ処理・DOM操作
- **Chart.js** - グラフ描画ライブラリ（軽量で高機能）
- **CSS3** - スタイリング

フレームワークは使用せず、シンプルな静的サイトとして構築。CSVファイルの読み込みと可視化に特化した軽量な実装。

## プロジェクト構造
```
├── index.html              # メインページ
├── css/
│   └── style.css          # スタイルシート
├── js/
│   ├── app.js             # メイン処理・UI制御
│   ├── csv-parser.js      # CSV解析・データ変換
│   └── chart-config.js    # Chart.js設定・グラフ生成
├── docs/                   # プロジェクトドキュメント
│   ├── requirements.md    # 機能要件定義
│   ├── ISSUES.md          # Issue管理・追跡
│   ├── development-log.md # 開発ログ・履歴
│   └── task-progress.md   # タスク進捗管理
├── tests/fixtures/        # テストデータ
│   └── multi-account/     # 複数アカウントテストデータ
│       ├── dev/costs.csv      # 開発環境コストデータ
│       ├── prod/costs.csv     # 本番環境コストデータ
│       └── staging/costs.csv  # ステージング環境コストデータ
└── README.md             # プロジェクト説明
```

## データ構造・取得方式
### アカウント登録ベース
- ユーザーがローカルCSVファイルをアップロード
- アカウント名は手動入力（dev, prod, staging等）
- 複数アカウントデータをブラウザ内で管理
- sessionStorageでデータ永続化

### 登録フロー
1. アカウント名入力 + CSVファイル選択
2. 「アカウントを追加」で登録
3. 登録済みアカウント一覧で管理
4. 複数登録後「データ分析開始」で可視化

### CSVファイル仕様
- 各CSVは同じ基本形式だが、利用サービスに応じて列の増減あり
- File APIで動的読み込み・解析
- アカウント名は固定ではなく柔軟に設定可能

## 開発ワークフロー
包括的開発ワークフローの章を参照すること
### ファイル確認・利用方法
- `index.html` - ブラウザで files://path でアクセス. pathは適切な値に設定する
- アカウント登録フォームでCSVファイルをアップロード
- 複数アカウント登録後、データ分析・可視化機能を利用

### デプロイ
静的ファイルのみなので、任意のWebサーバーやGitHub Pagesに配置可能。

## Git コミットルール
### コミット単位の基準
- **機能単位**: 1つの機能追加・修正は1コミットにまとめる
- **ファイル種別**: HTML、CSS、JSなど異なる種類の変更でも関連する機能なら同一コミット
- **ドキュメント**: 機能に関連するドキュメント更新は機能コミットに含める
- **設定ファイル**: プロジェクト設定の変更は独立したコミット

### コミットメッセージ形式
```
動詞 + 対象 + 簡潔な説明

🤖 Generated with [Claude Code](https://claude.ai/code)

Co-Authored-By: Claude <noreply@anthropic.com>
```

### 例
- `Add CSV parser and data visualization components`
- `Fix chart rendering issue for empty data`
- `Update project documentation and development guide`
- `Refactor data processing for better performance`

### プッシュタイミング
- 機能が完成してテストが通った段階で速やかにプッシュ
- 複数の小さな関連コミットは一度にプッシュしても可

## 開発ログ管理
### `docs/development-log.md` 運用ルール
- **継続更新**: 主要な開発活動・技術的決定を随時記録
- **記録タイミング**: 
  - 新機能実装完了時
  - 重要な技術的決定時
  - 問題解決・バグ修正時
  - プロジェクト構成変更時
- **記録内容**:
  - 日付・概要
  - 実施内容（詳細な作業項目）
  - 技術的決定事項と理由
  - 作成・更新したファイル
  - Git操作履歴（コミットハッシュ）
- **フォーマット**: 日付ごとのセクション形式で時系列記録

## テスト戦略・ワークフロー
### テスト実装ルール
- **テスト駆動開発**: 機能実装と並行してテストを作成
- **機能完了時テスト**: 1機能開発完了毎に必ず関連テストを実装
- **回帰テスト**: 機能完了毎に全テストスイートを実行
- **テスト必須タイミング**:
  - 新機能実装完了時
  - バグ修正完了時
  - リファクタリング完了時
  - プルリクエスト作成前

### テスト環境
- **フレームワーク**: Jest + JSDOM
- **テストタイプ**:
  - Unit Tests: 個別関数・モジュールテスト
  - Integration Tests: 複数モジュール連携テスト
  - Multi-account Tests: 複数アカウントデータ処理テスト
- **テストコマンド**:
  - `npm test` - 全テスト実行
  - `npm run test:watch` - 監視モード
  - `npm run test:coverage` - カバレッジ付き実行

### テストデータ構造
```
tests/fixtures/
├── multi-account/     # dev, prod, staging環境データ
├── edge-cases/        # 空データ、異常データ、異なるサービス構成
└── expected-results/  # 期待される処理結果データ
```

### 品質基準
- **テストカバレッジ**: 主要ロジック80%以上
- **テスト実行**: 機能完了毎の必須実行
- **テスト成功**: 全テストパス後のみコミット許可

## E2E テスト・操作検証
### Playwright操作検証ルール
- **実施タイミング**: 
  - UI機能実装完了時
  - JavaScript機能追加・修正時
  - フェーズ完了時
  - プルリクエスト作成前
- **検証内容**:
  - USER_MANUAL.md記載の操作手順に沿った検証
  - 主要ユーザーフローの動作確認
  - エラーハンドリングの動作確認
  - レスポンシブ対応の確認
- **検証方法**:
  - Playwright MCPでブラウザ操作
  - 各操作ステップの成功・失敗記録
  - スクリーンショット取得（必要時）
  - コンソールエラーの確認

### E2Eテスト実施基準
- **必須実施**: UI変更・JS機能追加時
- **推奨実施**: CSS変更・レイアウト修正時
- **記録必須**: 問題発見時は詳細記録・修正対応
- **マニュアル連動**: 操作手順変更時はマニュアル同期更新

### テスト環境
- **ブラウザアクセス**: `file://` または `http://localhost:8000`
- **テストデータ**: `tests/fixtures/` 配下のCSVファイル活用
- **検証項目**: アカウント登録→データ処理→可視化の全フロー

### Playwrightブラウザタブ管理ルール
**重要**: 各テスト間で適切にブラウザタブをクリーンアップすること

#### タブ管理の問題と対策
- **問題**: 開きっぱなしのタブが固まってタイムアウト連続発生
- **対策**: テスト毎にタブを開き直して完全な初期状態を確保

#### 推奨実装パターン
```javascript
// ✅ 推奨: テスト毎にタブ開閉
test('test name', async ({ browser }) => {
    const context = await browser.newContext();
    const page = await context.newPage();
    
    try {
        // テスト処理
        await page.goto(url);
        // ... テスト内容
    } finally {
        // 必ずクリーンアップ
        await page.close();
        await context.close();
    }
});

// ❌ 非推奨: タブの使い回し
// 前のテストの状態が残ってタイムアウト・固まりの原因
```

#### タブ管理ベストプラクティス
1. **各テスト独立性**: 前のテストの影響を受けない新しいタブ使用
2. **例外処理での確実クリーンアップ**: finally文でタブ・コンテキスト閉じる
3. **タイムアウト設定**: 適切なタイムアウト値設定で無限待機回避
4. **エラー時の復旧**: テスト失敗時も次のテストに影響しない設計
5. **メモリ管理**: 使用済みタブの確実な解放でリソースリーク防止

#### テスト実装例
- **参考ファイル**: `tests/e2e/browser-management.test.js`
- **ヘルパークラス**: `BrowserTestManager` でタブ管理を統一
- **クリーンアップ検証**: テスト後のコンテキスト数確認

### Issue管理・記録ルール
- **Issue発見時の対応**:
  - 即座に`docs/ISSUES.md`に詳細記録
  - Issue ID（連番）で管理
  - 発見日時・症状・再現手順を記録
  - 重要度（Critical/High/Medium/Low）設定
- **Issue記録内容**:
  - **基本情報**: ID、タイトル、発見日、重要度
  - **症状詳細**: 期待動作 vs 実際動作
  - **再現手順**: 具体的なステップ
  - **環境情報**: ブラウザ、OS、ファイル等
  - **修正状況**: Open/In Progress/Fixed/Verified
- **修正完了基準**:
  - コード修正完了
  - Unit/E2Eテストでの修正確認
  - Playwright操作検証での再検証完了
- **Issue更新ルール**:
  - 修正着手時: ステータス更新
  - 修正完了時: 修正内容・日時記録
  - 検証完了時: Verifiedに更新

## タスク管理・進捗追跡
### `docs/task-progress.md` 運用ルール
- **進捗管理**: 実装計画を詳細タスクに分解し、ステータス管理
- **ステータス定義**:
  - 🔲 **未実施**: まだ開始していないタスク
  - 🔄 **対応中**: 現在実装中のタスク
  - ✅ **完了**: 実装・テスト完了済みタスク
- **更新タイミング**:
  - タスク開始時: 未実施→対応中
  - タスク完了時: 対応中→完了
  - 新規タスク発生時: 表への追加
  - 計画変更時: タスク内容・優先度修正
- **管理内容**:
  - フェーズ別タスク分類
  - 担当ファイル明記
  - テスト実装タスクも含む
  - 進捗サマリー更新
- **継続更新**: 作業計画修正・追加作業発生時の都度反映

## 包括的開発ワークフロー
### 機能実装の標準手順
機能追加・修正時は以下の手順を必ず実行すること：

#### 1. 機能実装
- **実装内容**: 新機能・修正内容の開発
- **実装ファイル**: 該当する .js, .html, .css ファイルの修正
- **品質基準**: 既存コードスタイル・パターンに準拠

#### 2. 単体テスト実行・実装
- *タイムアウトになるため現在は実施不要*
- **実行コマンド**: `npm test` で既存テスト確認
- **新規テスト**: 実装機能に対応するテストケース追加
- **カバレッジ**: 主要ロジック80%以上の確保
- **テスト成功**: 全テストパス確認必須

#### 3. ユーザーマニュアル更新
- **対象ファイル**: USER_MANUAL.md
- **更新内容**: 新機能・変更された操作手順の記載
- **更新タイミング**: UI変更・操作フロー変更時
- **操作手順**: 具体的なステップ・スクリーンショット説明

#### 4. Playwright E2E検証
- **検証タイミング**: UI機能実装完了時必須
- **検証内容**: USER_MANUAL.md記載の操作手順に沿った検証
- **確認項目**:
  - 新機能の正常動作確認
  - 既存機能への影響確認
  - エラーハンドリング動作確認
  - コンソールエラーチェック

#### 5. ドキュメント更新（必須3ファイル）
- **`docs/development-log.md`更新**:
  - 実施内容・技術的決定・ファイル変更履歴
  - 日付・概要・詳細作業項目記録
- **`docs/task-progress.md`更新**:
  - 完了タスクのステータス更新（🔲→✅）
  - 進捗サマリー・パーセンテージ更新
- **`docs/ISSUES.md`更新**:
  - 新Issue発見時の詳細記録
  - 修正完了時のステータス・検証結果更新

#### 6. Git コミット・プッシュ
- **ステージング**: `git add .` で変更ファイル追加
- **コミット**: 標準メッセージ形式でコミット作成
- **プッシュ**: `git push` でリモートリポジトリ更新
- **タイミング**: 機能完成・テスト通過・ドキュメント更新完了後

### ワークフロー実行基準
- **必須実行**: 全ての機能追加・修正時
- **実行順序**: 上記1-6の順序で必ず実行
- **品質ゲート**: 各ステップ完了確認後に次ステップ進行

## カスタムスラッシュコマンド
### `/workflow` - 包括的開発ワークフロー自動実行
上記の包括的開発ワークフローを自動実行するカスタムコマンド

#### 設定場所
- **コマンド定義**: `.claude/slash-commands/workflow.md`
- **設定ファイル**: `.claude/config.yaml`

#### 利用可能ツール
```yaml
allowed-tools:
  - Read, Edit, Write, Glob, Grep
  - Bash(git:*, npm:test, npm:run)
  - TodoWrite
  - mcp__playwright__browser_* (E2E検証用)
```

#### 使用方法
Claude Code で `/workflow` と入力するだけで8ステップの包括的ワークフローが自動実行される
- **例外処理**: Issue発見時は即座にISSUES.md記録・修正対応

### 品質保証
- **回帰テスト**: 既存機能への影響確認必須
- **E2E検証**: ユーザー視点での動作確認必須
- **ドキュメント同期**: 実装内容とドキュメントの整合性確保
- **継続的改善**: ワークフロー実行時の問題点・改善点の記録
